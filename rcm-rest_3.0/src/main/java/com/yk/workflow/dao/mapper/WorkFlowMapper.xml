<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yk.workflow.dao.IWorkFlowMapper">
	
	<select id="getMyTaskCount" resultType="int" parameterType="map">
	select count(1) from (
      select t.id_
	  from act_ru_task     t,
	       act_hi_procinst p,
	       act_re_procdef  a
	 where t.proc_inst_id_ = p.proc_inst_id_
	   and p.proc_def_id_ = a.id_
	   and t.assignee_ = #{userId}
	    and a.key_ not in ('bulletin','noticeDecision','formalReview','preReview')
	union 
	   select t.id_ from act_ru_task t, rcm_bulletin_log p
	   where p.taskid=t.id_
	   and p.auditstatus='9' and p.audituserid=#{userId}
	union 
		select t.id_ from act_ru_task t,rcm_formalassessment_log g  
    	where g.taskid = t.id_ and t.proc_def_id_ like 'formalReview%' and g.auditstatus='9'
		and g.audituserid=#{userId}
	union 
		select t.id_ from act_ru_task t,rcm_pre_log g  
    	where g.taskid = t.id_ and t.proc_def_id_ like 'preReview%' and g.auditstatus='9'
		and g.audituserid=#{userId}
	    )
	</select>
	
	<select id="queryMyTaskByPage" resultType="map" parameterType="map">
		select * from (
	      select '' taskmark ,t.id_,
		   t.proc_def_id_,
		   t.proc_inst_id_,
		   t.name_,
		   t.create_time_,
		   to_char(t.form_key_) form_key_,
		   to_char(p.business_key_) business_key_,
		   to_char(a.name_) as type_text,
		   (select to_char(v.text_)
		      from act_hi_varinst v
		     where v.name_ = 'subject'
		       and v.proc_inst_id_ = t.proc_inst_id_) as subject,
		   (select to_char(v.text_)
		      from act_hi_varinst v
		     where v.name_ = 'submitBy'
		       and v.task_id_ = t.id_) as submitby,
		   (select to_char(emergencyLevel) from rcm_formalassessment_info ri
		     where ri.businessid = p.business_key_) as emergencyLevel
		  from act_ru_task     t,
		       act_hi_procinst p,
		       act_re_procdef  a
		 where t.proc_inst_id_ = p.proc_inst_id_
		   and p.proc_def_id_ = a.id_
		   and t.assignee_ = '${userId}'
		   and a.key_ not in ('bulletin','noticeDecision','formalReview','preReview')
		union 
		  select '',
		   t.id_,
		   t.proc_def_id_,
		   t.proc_inst_id_,
		   t.name_,
		   t.create_time_,
		   to_char('bulletin') form_key_,
		   to_char(p.businessid) business_key_,
		   to_char('其它需决策事项') type_text,
		   (select bulletinname from rcm_bulletin_info where businessid=p.businessid) subject,
		   '' submitby,
		   '' emergencyLevel
		   from act_ru_task t, rcm_bulletin_log p
		   where p.taskid=t.id_
		   and p.auditstatus='9'
		   and p.audituserid='${userId}'
	union 
		select '',t.id_,
	       t.proc_def_id_,
	       t.proc_inst_id_,
         t.name_,
         t.create_time_,
         to_char('preReview') form_key_,
         to_char(g.businessid) business_key_,
         to_char('投标评审') type_text,
         (select projectname
            from rcm_pre_info
           where businessid = g.businessid) subject,
         '' submitby,
         decode((select emergencylevel
            from rcm_pre_info
           where businessid = g.businessid),null,'') emergencylevel
         from act_ru_task t,rcm_pre_log g  
    	where g.taskid = t.id_ and t.proc_def_id_ like 'preReview%' and g.auditstatus='9'
		and g.audituserid='${userId}'
	union 
		select g.taskmark,t.id_,
	       t.proc_def_id_,
	       t.proc_inst_id_,
         t.name_,
         t.create_time_,
         to_char('formalReview') form_key_,
         to_char(g.businessid) business_key_,
         to_char('正式评审') type_text,
         (select projectname
            from rcm_formalassessment_info
           where businessid = g.businessid) subject,
         '' submitby,
         decode((select emergencylevel
            from rcm_formalassessment_info
           where businessid = g.businessid),null,'') emergencylevel
         from act_ru_task t,rcm_formalassessment_log g  
    where g.taskid = t.id_ and t.proc_def_id_ like 'formalReview%' and g.auditstatus='9'
		and g.audituserid='${userId}'
    ) ta where 1=1
		<if test="createTime != null and createTime !=''"> and to_char(ta.create_time_,'yyyy-mm-dd')='${createTime}'</if>
		<if test="processKey != null and processKey != ''">
			<choose> 
				<when test="'formalReview' == processKey">and (ta.proc_def_id_ like '${processKey}%' or ta.proc_def_id_ like 'formalAssessment%')</when>
				<when test="'noticeDecision' == processKey">and (ta.proc_def_id_ like '${processKey}%' or ta.proc_def_id_ like 'noticeOfDecision%')</when>
				<otherwise>and ta.proc_def_id_ like '${processKey}%'</otherwise>
			</choose>
		</if>
		order by ta.create_time_ desc
	</select>
	
	<select id="getOverOrCompletedTaskCount" resultType="int" parameterType="map">
		select count(1) from (
			   select to_char(p.business_key_) business_key_,
		       p.start_time_,
		       p.end_time_ as end_time_,
		       to_char(a.key_) as type_,
		       to_char(a.name_) as type_text,
		       to_char(a.category_) as form_key,
		       to_char(p.proc_def_id_) proc_def_id_, 
		       to_char(p.proc_inst_id_) proc_inst_id_,
		       decode(p.end_time_,
		              null,
		              (select regexp_replace(listagg(to_char(t.name_), ',') within group(order by t.proc_inst_id_)
		                , '([^,]+)(,\1)+', '\1')
		                 from act_ru_task t
		                where t.proc_inst_id_ = p.proc_inst_id_),
		              '结束') as phase,
		       (select to_char(v.text_)
		          from act_hi_varinst v
		         where v.name_ = 'subject'
		           and v.proc_inst_id_ = p.proc_inst_id_) as subject
		  from act_hi_procinst p, act_re_procdef a
		 where p.proc_def_id_=a.id_ 
		       and exists (select *
		          from act_hi_taskinst t
		         where t.assignee_ = '${userId}' and t.proc_inst_id_=p.proc_inst_id_
		             and t.end_time_ is not null)
		 and p.business_key_ is not null and a.key_ in('preAssessment', 'formalAssessment', 'noticeOfDecision')
		union            
		select b.businessid business_key_,
       (select audittime 
          from rcm_bulletin_log 
         where auditstatus = 'A' 
           and orderby = 1 
           and businessid = b.businessid) start_time_, 
        case when b.auditstatus='2' or b.auditstatus='3' then 
          (select audittime from rcm_bulletin_log where auditstatus = '9' 
                  and businessid = b.businessid) 
          else null end end_time_,
       'bulletin' type_,
       '其它需决策事项' type_text,
       '' form_key,
       '' proc_def_id_,
       '' proc_inst_id_,
       (select listagg(taskdesc,'/') within GROUP (order by taskdesc) 
          from rcm_bulletin_log 
         where auditstatus = '9' 
           and businessid = b.businessid) phase,
       b.bulletinname subject 
      from rcm_bulletin_info b where b.businessid in
		(select businessid from rcm_bulletin_log bg where bg.iswaiting='0' and bg.audituserid='${userId}')
		union 
		select f.businessid business_key_,
		(select audittime from rcm_formalassessment_log where auditstatus='A' and orderby=2 and businessid=f.businessid) start_time_,
		f.complete_date end_time_,
		'formalReview' type_, '正式评审申请' type_text,'' form_key, '' proc_def_id_,'' proc_inst_id_,
		(select listagg(taskdesc,',') within group(order by taskdesc) from rcm_formalassessment_log where auditstatus='9' and businessid=f.businessid) phase,
		f.projectname subject
		 from rcm_formalassessment_info f where f.businessid in
		(select businessid from rcm_formalassessment_log fg where fg.iswaiting='0' and fg.audituserid='${userId}')
	    union 
		select f.businessid business_key_,
		(select audittime from rcm_pre_log where auditstatus='A' and orderby=2 and businessid=f.businessid) start_time_,
		f.complete_date end_time_,
		'preReview' type_, '投标评审申请' type_text,'' form_key, '' proc_def_id_,'' proc_inst_id_,
		(select listagg(taskdesc,',') within group(order by taskdesc) from rcm_pre_log where auditstatus='9' and businessid=f.businessid) phase,
		f.projectname subject
		 from rcm_pre_info f where f.businessid in
		(select businessid from rcm_pre_log fg where fg.iswaiting='0' and fg.audituserid='${userId}')
	    ) ta where 1=1  
<!-- 	    <choose>  -->
<!-- 			<when test="isCompleted == 1"> and ta.end_time_ is not null </when> -->
<!-- 			<otherwise> and ta.end_time_ is null </otherwise> -->
<!-- 		</choose> -->
	</select>
	
	<select id="queryOverOrCompletedTaskByPage" resultType="map" >
		select ta.* from (
			   select to_char(p.business_key_) business_key_,
		       to_char(p.start_time_, 'yyyy-mm-dd hh24:mi:ss') as start_time_,
		       to_char(p.end_time_, 'yyyy-mm-dd hh24:mi:ss') as end_time_,
		       to_char(a.key_) as type_,
		       to_char(a.name_) as type_text,
		       to_char(a.category_) as form_key,
		       to_char(p.proc_def_id_) proc_def_id_, 
		       to_char(p.proc_inst_id_) proc_inst_id_,
		       decode(p.end_time_,
		              null,
		              (select regexp_replace(listagg(to_char(t.name_), ',') within group(order by t.proc_inst_id_)
		                , '([^,]+)(,\1)+', '\1')
		                 from act_ru_task t
		                where t.proc_inst_id_ = p.proc_inst_id_),
		              '结束') as phase,
		       (select to_char(v.text_)
		          from act_hi_varinst v
		         where v.name_ = 'subject'
		           and v.proc_inst_id_ = p.proc_inst_id_) as subject
		  from act_hi_procinst p, act_re_procdef a
		 where p.proc_def_id_=a.id_ 
		       and exists (select *
		          from act_hi_taskinst t
		         where t.assignee_ = '${userId}' and t.proc_inst_id_=p.proc_inst_id_
		             and t.end_time_ is not null)
		 and p.business_key_ is not null and a.key_ in('preAssessment', 'formalAssessment', 'noticeOfDecision')
		union 
		select b.businessid business_key_,
       (select to_char(audittime, 'yyyy-mm-dd hh24:mi:ss')  
          from rcm_bulletin_log 
         where auditstatus = 'A' 
           and orderby = 1 
           and businessid = b.businessid) start_time_, 
        case when b.auditstatus='2' or b.auditstatus='3' then 
          (select to_char(audittime, 'yyyy-mm-dd hh24:mi:ss') from rcm_bulletin_log where auditstatus = '9' 
                  and businessid = b.businessid) 
          else null end end_time_,
       'bulletin' type_,
       '其它需决策事项' type_text,
       '' form_key,
       '' proc_def_id_,
       '' proc_inst_id_,
       (select listagg(taskdesc,'/') within GROUP (order by taskdesc) 
          from rcm_bulletin_log 
         where auditstatus = '9' 
           and businessid = b.businessid) phase,
		b.bulletinname subject
		 from rcm_bulletin_info b where b.businessid in
		(select businessid from rcm_bulletin_log bg where bg.iswaiting='0' and bg.audituserid='${userId}')
		union 
		select f.businessid business_key_,
		to_char((select audittime from rcm_formalassessment_log where auditstatus='A' and orderby=2 and businessid=f.businessid), 'yyyy-mm-dd hh24:mi:ss') start_time_,
		to_char(f.complete_date, 'yyyy-mm-dd hh24:mi:ss') as end_time_,
		'formalReview' type_, '正式评审申请' type_text,'' form_key, '' proc_def_id_,'' proc_inst_id_,
		(select listagg(taskdesc,',') within group(order by taskdesc) from rcm_formalassessment_log where auditstatus='9' and businessid=f.businessid) phase,
		f.projectname subject
		 from rcm_formalassessment_info f where f.businessid in
		(select businessid from rcm_formalassessment_log fg where fg.iswaiting='0' and fg.audituserid='${userId}')
	   union 
		select f.businessid business_key_,
		to_char((select audittime from rcm_pre_log where auditstatus='A' and orderby=2 and businessid=f.businessid), 'yyyy-mm-dd hh24:mi:ss') start_time_,
		to_char(f.complete_date, 'yyyy-mm-dd hh24:mi:ss') as end_time_,
		'preReview' type_, '投标评审申请' type_text,'' form_key, '' proc_def_id_,'' proc_inst_id_,
		(select listagg(taskdesc,',') within group(order by taskdesc) from rcm_pre_log where auditstatus='9' and businessid=f.businessid) phase,
		f.projectname subject
		 from rcm_pre_info f where f.businessid in
		(select businessid from rcm_pre_log fg where fg.iswaiting='0' and fg.audituserid='${userId}')
	    ) ta where 1=1 
<!-- 	    <choose>  -->
<!-- 			<when test="isCompleted == 1"> ta.end_time_ is not null</when> -->
<!-- 			<otherwise> ta.end_time_ is null </otherwise> -->
<!-- 		</choose> -->
		<if test="subject != null and subject != ''">and ta.subject like '%${subject}%'</if>
		<if test="processKey != null and processKey != ''">
			<choose> 
				<when test="'formalReview' == processKey">and (ta.type_ = '${processKey}' or ta.type_ = 'formalAssessment')</when>
				<when test="'noticeDecision' == processKey">and (ta.type_ = '${processKey}' or ta.type_ = 'noticeOfDecision')</when>
				<otherwise>and type_ = '${processKey}'</otherwise>
			</choose>
		</if>
		order by ta.start_time_ desc
	</select>
	
	<!-- 查询流程审批历史 -->
	<select id="selectProcessInstanceApproveHistory" resultType="map" >
		select u.NAME as userName,
		       t.name_ as taskName,
		       (select v.text_
		                  from act_hi_varinst v
		                 where v.name_ = 'opinion'
		                   and v.task_id_ = t.id_) as opinion,
		       to_char(t.start_time_, 'yyyy-mm-dd hh24:mi:ss') as startTime,
		       to_char(t.end_time_, 'yyyy-mm-dd hh24:mi:ss') as endTime,
		       (select v.text_
		                  from act_hi_varinst v
		                 where v.name_ = 'emergencyLevel'
		                   and v.task_id_ = t.id_) as emergencyLevel
		  from act_hi_taskinst t, sys_user u
		 where t.proc_inst_id_ = #{processInstanceId}
		   and t.assignee_ = u.UUID
		   order by t.start_time_
	</select>
	
	<!-- 流程审批的时候查询已办和待办，同步给门户 -->
	<select id="selectForPortal" resultType="map" >
		select uniid, title, sender, depart,url,created, owner, type, status, record_status, priority from (
          select ta.*,
                 (decode(ta.status,'1',ta.form_key_,a.category_) || '/' || p.business_key_ ||
                  '@' || p.proc_def_id_ || '@' ||p.proc_inst_id_ || '@' || ta.uniid) as url,
                 to_char(ta.created_, 'yyyy-mm-dd hh24:mi:ss') as created,
                 nvl(decode(pri.text_, '一般', '1', '紧急', '2', '特急', '3', ''),1) as priority,
                 subject.text_ as title,
                 cu.NAME as sender,
                 cu.depart
            from (select t.proc_def_id_,
                         t.proc_inst_id_,
                         t.id_ as uniid,
                         t.end_time_ as created_,
                         t.assignee_ as owner,
                         '1' as type,
                         '2' as status,
                         '2' as record_status,
                         '' as form_key_
                    from act_hi_taskinst t
                   where t.id_ = '${preTaskId}'
                  union 
                  select t.proc_def_id_,
                         t.proc_inst_id_,
                         t.id_ as uniid,
                         t.create_time_ as created_,
                         t.assignee_ as owner,
                         '1' as type,
                         '1' as status,
                         '1' as record_status,
                         to_char(t.form_key_) as form_key_
                    from act_ru_task t
                   where t.id_ in (${currentTaskIds})) ta,
                 (select v.text_, v.task_id_
                    from act_hi_varinst v
                   where v.name_ = 'emergencyLevel') pri,
                 (select v.text_, v.proc_inst_id_
                    from act_hi_varinst v
                   where v.name_ = 'subject') subject,
                 act_re_procdef a,
                 act_hi_procinst p,
                 view_user_dep cu
           where ta.proc_def_id_ = a.id_
             and ta.proc_inst_id_ = p.proc_inst_id_
             and ta.uniid = pri.task_id_(+)
             and ta.proc_inst_id_ = subject.proc_inst_id_
             and p.start_user_id_ = cu.UUID
        )
	</select>
	
	<!-- 查询我的项目 -->
	<select id="queryMyProjectInfoByPage" resultType="map" >
		select p.*,(select o.name from sys_org o where o.ORGPKVALUE = p.pertainarea_id) pertainarea_name 
		from rcm_v_project_info p 
		where 1=1 
		<if test="reviewpersonId != null">
			and p.REVIEWPERSON_ID = #{reviewpersonId}
		</if>
		<if test="createby != null">
			and p.CREATEBY = #{createby}
		</if>
		order by p.PROJECT_TYPE,TO_NUMBER(p.STAGE) desc,nvl(p.APPLY_DATE, p.CREATE_DATE) desc
	</select>
</mapper>
